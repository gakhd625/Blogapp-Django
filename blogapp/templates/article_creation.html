{% extends 'base.html' %}
{% block content %}

<div style="border: 1px solid #ccc; border-radius: 6px; padding: 20px;">
    <h4><strong>Article Creation</strong></h4>

    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h5>Article Creation</h5>
        <table>
            <tr>
                <td style="width: 150px;">Keyword</td>
                <td>
                    <input type="text" id="keyword-input" placeholder="Enter keyword/topic for article generation" class="form-control">
                </td>
            </tr>
            <tr style="height: 15px;"></tr>
            <tr>
                <td>Search Engine</td>
                <td>
                    <select id="search_engine" class="form-select">
                        <option value="google">Google</option>
                        <option value="bing">Bing</option>
                    </select>
                </td>
            </tr>
        </table>
        <div id="ai-messages" style="margin-top: 10px;"></div>
            <button type="button" id="generate-btn" class="btn btn-primary">
                <span id="generate-text">Generate Article</span>
                <span id="loading-text" style="display: none;">Generating...</span>
            </button>
    </div>
    <form method="POST">
        {% csrf_token %}
            <tr>
                <td style="width: 150px;">Title</td>
                <td>
                    <input type="text" id="title-input" name="title" placeholder="Article Title" class="form-control" required>
                </td>
            </tr>
            <tr style="height: 15px;"></tr>
            <tr>
                <td ><h4><strong>Generated Article Preview</strong></td>
                <td>
                    <textarea id="content-textarea" name="content" placeholder="Write your article content here or generate using AI..." class="form-control" rows="10" required></textarea>
                </td>
            </tr>
            <table>
                <tr>
                    <td>Status</td>
                    <td>
                        <select name="status" id="status" class="form-select">
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="archived">Archived</option>
                        </select>
                    </td>
                </tr>
                <tr style="height: 15px;"></tr>
                <tr>
                    <td>Target Blog</td>
                    <td>
                        <select id="blog-select-ai" class="form-select">
                            <option value="">Select a blog (optional)</option>
                            {% for blog in form.fields.blog.queryset %}
                                <option value="{{ blog.id }}">{{ blog.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary" style="margin-left: 10px;">Post</button>
                    </td>
                </tr>
            </table>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-btn');
    const blogSelectAI = document.getElementById('blog-select-ai');
    const titleInput = document.getElementById('title-input');
    const contentTextarea = document.getElementById('content-textarea');
    const blogSelect = document.getElementById('blog');
    const aiMessages = document.getElementById('ai-messages');
    const generateText = document.getElementById('generate-text');
    const loadingText = document.getElementById('loading-text');

    generateBtn.addEventListener('click', function() {

        generateBtn.disabled = true;
        generateText.style.display = 'none';
        loadingText.style.display = 'inline';
        clearAIMessages();
        const requestData = {
            blog_id: blogSelectAI.value
        };
        fetch('{% url "generate_article" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                titleInput.value = data.title;
                contentTextarea.value = data.content;
                if (blogSelectAI.value) {
                    blogSelect.value = blogSelectAI.value;
                }
                
                showAIMessage('Article generated successfully! Review and edit as needed.', 'success');
                contentTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showAIMessage('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAIMessage('An unexpected error occurred. Please try again.', 'error');
        })
        .finally(() => {
            generateBtn.disabled = false;
            generateText.style.display = 'inline';
            loadingText.style.display = 'none';
        });
    });

    function showAIMessage(message, type) {
        clearAIMessages();
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
        messageDiv.style.padding = '8px 12px';
        messageDiv.style.marginTop = '10px';
        messageDiv.style.borderRadius = '4px';
        messageDiv.textContent = message;
        aiMessages.appendChild(messageDiv);
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    }

    function clearAIMessages() {
        aiMessages.innerHTML = '';
    }
});
</script>
{% endblock %}